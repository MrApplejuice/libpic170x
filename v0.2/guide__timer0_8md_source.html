<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libpic170x: doc/src/guide_timer0.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.svg.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libpic170x
   &#160;<span id="projectnumber">0.2</span>
   </div>
   <div id="projectbrief">Ease of use library for PIC16(L)1705/1709 chips</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">doc/src/guide_timer0.md</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;Guide: Timer0 library  {#timer0-guide}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;=====================</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;The timer0 library allows rough time keeping by implementing a counter that counts the elapsed milliseconds (and micro seconds) using the PIC&#39;s timer0. The counter is updated using an interrupt handler that must be invoked in the general interrupt handler routine. The counter explicitly is designed for _rough_ time keeping to not waste too many processor cycles on updating the counter. Increments are limited to a maximum of ~131 ms by adjusting the internal timer0 prescaler. This should be generally be precise enough to handle user-oriented delays and timings. This library is explicitly not designed for close time keeping.</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;# Timing details</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;The details on how timer0 works can be read in the PIC specifications. However, generally timer0 is configured to use the PIC&#39;s base-clock, which is defined using `_XTAL_FREQ` and definitions from freq.h. Selecting a higher base-clock, will generally lead to a higher timer resolution. For low frequencies the timer0 prescaler is adjusted to increase the relative frequency of counter updates so that the maximum interval between counter increments stays at ~131ms. Note that this increased relative update rate will use up more processor cycles. Generally, it is advisable to only use `_XTAL_FREQ &gt;= 2000000` so that the maxium timer0 prescaler of 256 can be used which will lead to less frequent updates, therefore costing the least possible processing overhead with a good update resolution of `&lt;= 65ms`.</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;Prescaler values and increments can be changed in `freq.h` by adjusting the `TIMER0_`-definitions directly.</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;# Using timer0.h</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;timer0.h defines the global struc Timer0 which contains the readable, and writeable counter values. It also defines a global variable [pic170x_timer0](@ref pic170x_timer0) whcih is the default data structure that will be used if no custom data structure is defined. Note that this global data structure must be initializted as well before being used by calling `timer0_init(NULL)`.</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;The simplest way to use the timer0 library is to rely on the global data structure:</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;~~~~~~~~~~~~~~~~{.c}</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;#include &lt;xc.h&gt;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;#include &lt;timer0.h&gt;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;// ... config words etc ...</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;void interrupt interrupt_handler() {</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  timer0_ih(NULL);</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;}</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;int main() {</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;  OSCCON = OSCCON_BITS;</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;  timer0_init(NULL);</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;  GIE = 1; // Interrupts must be enabled manually</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  __delay_ms(1000);</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  int ms_elapsed = pic170x_timer0.ms;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  // ...</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;}</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;~~~~~~~~~~~~~~~~</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;Things to note here are that the interrupt handler must be defined in the main-application and invoke timer0_ih(). Also, even though timer0_init() enables timer0-interrupts, the global interrupt flag must still be enabled to enable the counter. After doing so the counter will be updated with every timer0-interrupt that is generated.</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;In the example, `pic170x_timer0.ms` is read to extract the ms that elapsed since the start of the program. Another, feature that might be interesting is that the values of the data structure are also writable, allowing the implementation of simple wait patterns, like these:</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;~~~~~~~~~~~~~~~~~~{.c}</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;//...</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;pic170x_timer0.ms = 0;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;while (pic170x_timer0.ms &lt; 10000) {</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  // do something</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;}</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;// continue with other things</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;~~~~~~~~~~~~~~~~~~</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;This can be useful when waiting for user input, or to implement blocking I/O with timeout functionality. One important thing to keep in mind is that if doing read-check-modify operations interrupt-updated values (e.g. `pic170x_timer0`), GIE should be disabled during the interaction, to prevent undefined states from ocurring:</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;~~~~~~~~~~~~~~~~~~{.c}</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;// Prevent timer from being updated by</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;// the interrupt, leading to undefined values</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;GIE = 0;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;if (pic170x_timer0.ms &gt; 1000) {</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  pic170x_timer0.ms -= 1000;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  GIE = 1;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  do_sth();</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;} else {</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  GIE = 1;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;}</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;~~~~~~~~~~~~~~~~~~</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div></div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
