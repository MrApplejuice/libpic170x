<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libpic170x: Guide: Timer0 library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.svg.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libpic170x
   &#160;<span id="projectnumber">0.1</span>
   </div>
   <div id="projectbrief">Ease of use library for PIC16(L)1705/1709 chips</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Guide: <a class="el" href="structTimer0.html">Timer0</a> library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The timer0 library allows rough time keeping by implementing a counter that counts the elapsed milliseconds (and micro seconds) using the PIC's timer0. The counter is updated using an interrupt handler that must be invoked in the general interrupt handler routine. The counter explicitly is designed for <em>rough</em> time keeping to not waste too many processor cycles on updating the counter. Increments are limited to a maximum of ~131 ms by adjusting the internal timer0 prescaler. This should be generally be precise enough to handle user-oriented delays and timings. This library is explicitly not designed for close time keeping.</p>
<p>The details on how timer0 works can be read in the PIC specifications. However, generally timer0 is configured to use the PIC's base-clock, which is defined using <code>_XTAL_FREQ</code> and definitions from <a class="el" href="freq_8h.html">freq.h</a>. Selecting a higher base-clock, will generally lead to a higher timer resolution. For low frequencies the timer0 prescaler is adjusted to increase the relative frequency of counter updates so that the maximum interval between counter increments stays at ~131ms. Note that this increased relative update rate will use up more processor cycles. Generally, it is advisable to only use <code>_XTAL_FREQ &gt;= 2000000</code> so that the maxium timer0 prescaler of 256 can be used which will lead to less frequent updates, therefore costing the least possible processing overhead with a good update resolution of <code>&lt;= 65ms</code>.</p>
<p>Prescaler values and increments can be changed in <code><a class="el" href="freq_8h.html">freq.h</a></code> by adjusting the <code>TIMER0_</code>-definitions directly.</p>
<p><a class="el" href="timer0_8h.html">timer0.h</a> defines the global struc <a class="el" href="structTimer0.html">Timer0</a> which contains the readable, and writeable counter values. It also defines a global variable <a class="el" href="timer0_8h.html#a34761ff49e17c7d609accd6e80e0da60">pic170x_timer0</a> whcih is the default data structure that will be used if no custom data structure is defined. Note that this global data structure must be initializted as well before being used by calling <code>timer0_init(NULL)</code>.</p>
<p>The simplest way to use the timer0 library is to rely on the global data structure:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;xc.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer0_8h.html">timer0.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">// ... config words etc ...</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> interrupt interrupt_handler() {</div><div class="line">  <a class="code" href="timer0_8h.html#ad11394130726cd23c6d5b94cbef68bf0">timer0_ih</a>(NULL);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main() {</div><div class="line">  OSCCON = OSCCON_BITS;</div><div class="line"></div><div class="line">  <a class="code" href="timer0_8h.html#ac02403d0a0ecbf2c2b4a5d92b0178bc1">timer0_init</a>(NULL);</div><div class="line">  GIE = 1; <span class="comment">// Interrupts must be enabled manually</span></div><div class="line"></div><div class="line">  __delay_ms(1000);</div><div class="line"></div><div class="line">  <span class="keywordtype">int</span> ms_elapsed = pic170x_timer0.<a class="code" href="structTimer0.html#a5fe5c367c4c2bcf13ab57c78a121f321">ms</a>;</div><div class="line">  <span class="comment">// ...</span></div><div class="line">}</div></div><!-- fragment --><p>Things to note here are that the interrupt handler must be defined in the main-application and invoke <a class="el" href="timer0_8h.html#ad11394130726cd23c6d5b94cbef68bf0">timer0_ih()</a>. Also, even though <a class="el" href="timer0_8h.html#ac02403d0a0ecbf2c2b4a5d92b0178bc1">timer0_init()</a> enables timer0-interrupts, the global interrupt flag must still be enabled to enable the counter. After doing so the counter will be updated with every timer0-interrupt that is generated.</p>
<p>In the example, <code>pic170x_timer0.ms</code> is read to extract the ms that elapsed since the start of the program. Another, feature that might be interesting is that the values of the data structure are also writable, allowing the implementation of simple wait patterns, like these:</p>
<div class="fragment"><div class="line"><span class="comment">//...</span></div><div class="line"></div><div class="line">pic170x_timer0.<a class="code" href="structTimer0.html#a5fe5c367c4c2bcf13ab57c78a121f321">ms</a> = 0;</div><div class="line"><span class="keywordflow">while</span> (pic170x_timer0.<a class="code" href="structTimer0.html#a5fe5c367c4c2bcf13ab57c78a121f321">ms</a> &lt; 10000) {</div><div class="line">  <span class="comment">// do something</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// continue with other things</span></div></div><!-- fragment --><p>This can be useful when waiting for user input, or to implement blocking I/O with timeout functionality. One important thing to keep in mind is that if doing read-check-modify operations interrupt-updated values (e.g. <code>pic170x_timer0</code>), GIE should be disabled during the interaction, to prevent undefined states from ocurring:</p>
<div class="fragment"><div class="line"><span class="comment">// Prevent timer from being updated by</span></div><div class="line"><span class="comment">// the interrupt, leading to undefined values</span></div><div class="line">GIE = 0;</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (pic170x_timer0.<a class="code" href="structTimer0.html#a5fe5c367c4c2bcf13ab57c78a121f321">ms</a> &gt; 1000) {</div><div class="line">  pic170x_timer0.<a class="code" href="structTimer0.html#a5fe5c367c4c2bcf13ab57c78a121f321">ms</a> -= 1000;</div><div class="line">  GIE = 1;</div><div class="line"></div><div class="line">  do_sth();</div><div class="line">} <span class="keywordflow">else</span> {</div><div class="line">  GIE = 1;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
